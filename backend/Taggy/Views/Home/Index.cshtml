<div class="panel panel-info">
	<div class="panel-heading">
		<h3 class="panel-title">Введите изображение с ценником</h3>
	</div>
	<div class="panel-body">
    	<form class="form" method="post" style="text-align: center;" enctype="multipart/form-data">
			<input type="file" id="file" name="file"/>
			<span class="percent2"></span>

			<input type="hidden" id="latitude" name="latitude" />
			<input type="hidden" id="longitude" name="longitude" />
			<input type="hidden" id="country-code" name="country-code" />
			<input type="hidden" id="country-name" name="country-name" />
			<input type="hidden" id="self-ip" name="self-ip" />

			<div class="progress2" style="background:#B4F5B4;height:20px;border-radius:3px;width: 0"></div>
			<span id="getting-location" class="label label-info"></span><hr />
			<button type="button" id="loading-button" data-loading-text="Загрузка..." class="btn btn-primary" autocomplete="off">Распознать</button>
		</form>
  	</div>
</div>

<div id="results-panel" class="panel panel-success">
	<div class="panel-heading">
		<h3 class="panel-title">Результат</h3>
	</div>
	<div id="results" class="panel-body">
		<p id="price"></p>
		<img id="image" class="img-responsive" /><br/>
    	<pre id="message"></pre>
  	</div>
</div>

@section scripts {
  	<script>
	  	
	  	$('#getting-location').html('Получение текущей позиции...');
	  	$.getJSON( "http://ip-api.com/json", function( data ) {
	  		if (data) {
	  			$('#latitude').val(data.lat);
		    	$('#longitude').val(data.lon);
		    	$('#country-code').val(data.countryCode);
		    	$('#country-name').val(data.country);
		    	$('#self-ip').val(data.query);
		    	$('#getting-location').html('Ваша страна: ' + $('#country-name').val() + '(' + $('#country-code').val() + ')');
	    	} else {
				$('#getting-location').html('Не удалось получить позицию.');
			}
		});

	$("#results-panel").hide();
	$('#loading-button').on('click', function () {
		var btn = $(this).button('loading');
		var t = $('#file')[0].files[0];
		if (!t) {
			btn.button('reset');
			return;
		}
		prj1551.imageResizer.resize({
			file: t,
			maxWidth: 580,
			maxHeight: 580,
			complete: function (result) {
				$("#image").attr("src", "data:image/jpeg;base64" + result.data);
				$("#results-panel").show();
				prj1551.imageResizer.upload({
					url: 'Convert',
					data: result.data,
					mimeType: t.type,
					fileName: t.name,
					formDataName: 'file',
					progressIndicator: '.progress2',
					percentIndicator: '.percent2',
					success: function(data) {
						btn.button('reset');
						$('.progress2').hide();
						$('.percent2').hide();
						var obj = jQuery.parseJSON(this.response);
						$('#price').html(obj.price);
						$('#message').html(obj.message);
						if (obj.ok) {
							$('#price').show();
							$('#message').hide();
						} else {
							$('#price').hide();
							$('#message').show();
						}
					}
				});
			}
		});
	});
	</script>
}